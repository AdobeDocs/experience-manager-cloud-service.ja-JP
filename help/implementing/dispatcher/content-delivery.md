---
title: コンテンツ配信
description: 'コンテンツ配信 '
translation-type: tm+mt
source-git-commit: d1c953e1caf440f18e488f07a32bcf5bc3880f67

---


# AEMでのクラウドサービスとしてのコンテンツ配信 {#content-delivery}

公開サービスのコンテンツ配信には、以下が含まれます。

* CDN（通常はアドビが管理）
* AEMディスパッチャー
* AEM公開

データフローは次のとおりです。

1. URLがブラウザーに追加されます。
1. DNSにマッピングされたCDNに対する要求をそのドメインに送信
1. コンテンツがCDN上で完全にキャッシュされている場合、CDNはコンテンツをブラウザーに提供します
1. コンテンツが完全にキャッシュされていない場合、CDNはディスパッチャーに（リバースプロキシ）を呼び出します
1. コンテンツがディスパッチャー上で完全にキャッシュされている場合、ディスパッチャーはCDNにそのコンテンツを提供します
1. コンテンツが完全にキャッシュされていない場合、ディスパッチャーはAEM発行に対して（リバースプロキシ）を呼び出します
1. コンテンツはブラウザーによってレンダリングされ、ヘッダーに応じてキャッシュされる場合もあります

コンテンツタイプHTML/textは、ディスパッチャーレイヤーで300秒（5分）後に期限切れになるように設定されます。この期限は、ディスパッチャーキャッシュとCDNの両方が考慮するしきい値です。 発行サービスの再デプロイメント中に、ディスパッチャーのキャッシュがクリアされ、その後、新しい発行ノードがトラフィックを受け入れる前にウォームアップされます。

以下の節では、CDN設定やディスパッチャーのキャッシュを含む、コンテンツ配信の詳細について説明します。

作成者サービスから発行サービスへの複製に関する情報は、こちらを参照して [ください](/help/operations/replication.md)。

>[!NOTE]
>トラフィックは、ディスパッチャーを含むモジュールをサポートするApache Webサーバーを経由します。 ディスパッチャーは、主に、パフォーマンスを向上させるために、パブリッシュノードでの処理を制限するキャッシュとして使用されます。

## CDN {#cdn}

AEMには次の3つのオプションがあります。

1. アドビが管理するCDN - AEMのCDN（標準搭載）。 これは完全に統合されているので、推奨されるオプションです。
1. 顧客CDNはアドビが管理するCDNを指します。顧客は、AEMの標準搭載CDNを自分のCDNで指し示します。 最初のオプションが使用できない場合は、これが次に推奨されるオプションです。これは、AEMのデフォルトのCDNとの統合を引き続き利用するためです。 お客様は、引き続きCDNの管理を担当します。
1. お客様管理CDN — お客様は独自のCDNを提供し、その管理を全面的に担当します。

>[!CAUTION]
>最初のオプションを強くお勧めします。 2つ目のオプションを選択した場合、設定ミスの結果に対してアドビは責任を負えません。

2つ目と3つ目のオプションは、ケースバイケースで許可されます。 これには、取り消しが困難なCDNベンダーとのレガシー統合を持つお客様を含む、特定の前提条件を満たすことが含まれます。

### アドビ管理CDN {#adobe-managed-cdn}

アドビの標準搭載CDNを使用してコンテンツ配信を準備する方法は簡単です。以下に説明します。

1. この情報を含む安全なフォームへのリンクを共有することで、署名済みのSSL証明書と秘密鍵をアドビに提供します。 この作業に関しては、カスタマーサポートにご相談ください。
注意：クラウドサービスとしてのAemは、ドメイン検証(DV)証明書をサポートしていません。
1. カスタマーサポートは、CNAME DNSレコードのタイミングを調整し、FQDNを示します `adobe-aem.map.fastly.net`。
1. SSL証明書の有効期限が切れると、新しいSSL証明書を再送信できるように通知されます。

アドビが管理するCDNの設定では、デフォルトで、すべてのパブリックトラフィックが、実稼働環境と非実稼働環境（開発およびステージ）の両方に対して、公開サービスに到達できます。 特定の環境の公開サービスへのトラフィックを制限する場合（ステージングを一定のIPアドレスで制限する場合など）は、カスタマーサポートと協力してこれらの制限を設定する必要があります。

### お客様のCDNはAdobe Managed CDNを指し示します。 {#point-to-point-CDN}

既存のCDNを使用したいが、顧客が管理するCDNの要件を満たしていない場合にサポートされます。 この場合は、独自のCDNを管理し、アドビの管理対象CDNを参照します。

次の点に注意してください。

1. 既存のCDNが必要です。
1. 君がやる
1. CDNをクラウドサービスとしてAemと連携するように設定する必要があります。設定手順を以下に示します。
1. 関連する問題が発生した場合に備えて通話中のエンジニアリングCDNエキスパートがいます。
1. 実稼働環境に移行する前に、ロードテストを実行し、成功させる必要があります。

設定手順：

1. ヘッダーをド `X-Forwarded-Host` メイン名で設定します。
1. ホストヘッダーを、アドビのCDNの入力であるオリジンドメインで設定します。 この値はAdobeから取得されます。
1. SNIヘッダーを元の場所に送信します。 ホストヘッダーと同様に、sniヘッダーは元のドメインである必要があります。
1. トラフィック `X-Edge-Key`をAEMサーバーに正しくルーティングするために必要なを設定します。 この値はAdobeから取得されます。

### お客様管理CDN {#customer-managed-cdn}

既存のCDNを使用する必要がある場合にサポートされます。  この場合、AEMを指す独自のCDNを管理します。

次の場合は、独自のCDNを管理できます。

1. 既存のCDNがある。
1. サポートされているCDNである必要があります。 現在、Akamaiがサポートされています。 現在サポートされていないCDNを管理したい場合は、カスタマーサポートにご連絡ください。
1. 君がやる
1. CDNをクラウドサービスとしてAemと連携するように設定する必要があります。設定手順を以下に示します。
1. 関連する問題が発生した場合に備えて通話中のエンジニアリングCDNエキスパートがいます。
1. 設定手順の説明に従って、CDNノードのホワイトリストをCloud Managerに提供する必要があります。
1. 実稼働環境に移行する前に、ロードテストを実行し、成功させる必要があります。

設定手順：

1. CDNベンダーのホワイトリストをアドビに提供します。これには、環境の作成/更新APIとホワイトリストのCIDRのリストを呼び出します。
1. ヘッダーをド `X-Forwarded-Host` メイン名で設定します。
1. ホストヘッダーに、Aemがクラウドサービスの入力として認識される元のドメインを設定します。 この値はAdobeから取得されます。
1. SNIヘッダーを元の場所に送信します。 SNIヘッダーは、元のドメインである必要があります。
1. AEMサーバーにトラ `X-Edge-Key` フィックを正しくルーティングするために必要なを設定します。 この値はAdobeから取得されます。

ライブトラフィックを受け入れる前に、アドビカスタマーサポートに問い合わせて、エンドツーエンドのトラフィックルーティングが正しく機能していることを検証する必要があります。

### キャッシング {#caching}

キャッシュ処理は、次に示すルールに従います。

### HTML/Text {#html-text}

* デフォルトでは、Apacheレイヤーによって生成されるキャッシュ制御ヘッダーに基づいて、ブラウザーによって5分間キャッシュされます。 CDNはこの値も順守します。
* は、AEMをクラウドサービスSDKディスパッチャーツールとして使用して変数を定 `EXPIRATION_TIME` 義することによ `global.vars` り、すべてのHTML/テキストコンテンツに対して上書きできます。

の下のファイルに次の規則が適用されてい `src/conf.dispatcher.d/cache` ることを確認する必要があります。

```
/0000
{ /glob "*" /type "allow" }
```

* apache mod_headersディレクティブを使用して、より詳細なレベルで上書きできます。 次に例を示します。

```
<LocationMatch "\.(html)$">
        Header set Cache-Control "max-age=200 s-maxage=200"
</LocationMatch>
```

の下のファイルに次の規則が適用されてい `src/conf.dispatcher.d/cache` ることを確認する必要があります。

```
/0000
{ /glob "*" /type "allow" }
```

* dispatcher-ttl AEM ACS Commonsプロジェクトを含む [他のメソッドは、値を正常に上書きしない](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-ttl/)ことに注意してください。

### クライアント側ライブラリ(js、css) {#client-side-libraries}

* aemのクライアント側ライブラリフレームワークを使用すると、変更が新しいファイルとして一意のパスで表示されるので、JavaScriptとCSSコードは、ブラウザーで無期限にキャッシュできるように生成されます。  つまり、クライアントライブラリを参照するHTMLが必要に応じて作成され、ユーザーが公開時に新しいコンテンツを体験できるようになります。 「immutable」値を考慮しない古いブラウザーでは、cache-controlは「immutable」または30日に設定されます。
* 詳しくは、クライア [ント側のライブラリとバージョンの整合性](#content-consistency) （英語のみ）を参照してください。

### 画像 {#images}

* キャッシュされない

### その他のコンテンツタイプ {#other-content}

* デフォルトのキャッシュなし
* はApacheで上書きできま `mod_headers`す。 次に例を示します。

```
<LocationMatch "\.(css|js)$">
    Header set Cache-Control "max-age=500 s-maxage=500"
</LocationMatch>
```

*キャッシュヘッダを設定する他の方法も機能する場合があります。

ライブトラフィックを受け入れる前に、顧客はアドビカスタマーサポートに問い合わせて、エンドツーエンドのトラフィックルーティングが正しく機能していることを検証する必要があります。

## Dispatcher {#disp}

トラフィックは、ディスパッチャーを含むモジュールをサポートするApache Webサーバーを経由します。 ディスパッチャーは、主に、パフォーマンスを向上させるために、パブリッシュノードでの処理を制限するキャッシュとして使用されます。

HTML/テキストタイプのコンテンツは、300秒（5分）の有効期限に対応するキャッシュヘッダーで設定されます。

この節の残りの部分では、ディスパッチャーキャッシュの無効化に関する考慮事項について説明します。

### アクティブ化/非アクティブ化中のディスパッチャーキャッシュの無効化 {#cache-activation-deactivation}

以前のバージョンのAEMと同様に、ページの公開または非公開では、ディスパッチャーのキャッシュからコンテンツがクリアされます。 キャッシュの問題の疑いがある場合は、該当するページを再公開する必要があります。

発行インスタンスは、作成者から新しいバージョンのページまたはアセットを受け取ると、フラッシュエージェントを使用してディスパッチャー上の適切なパスを無効にします。 更新されたパスは、親と共に1つのレベルまで、ディスパッチャーキャッシュから削除されます( [statfileslevelを使用して設定できます](https://docs.adobe.com/content/help/en/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#invalidating-files-by-folder-level))。

### 明示的なディスパッチャーキャッシュの無効化 {#explicit-invalidation}

一般に、ディスパッチャー内のコンテンツを手動で無効にする必要はありませんが、以下に説明するように、必要に応じて無効にすることができます。

AEMをクラウドサービスとして使用する前は、ディスパッチャーキャッシュを無効にする方法が2つありました。

1. 発行ディスパッチャーフラッシュエージェントを指定して、複製エージェントを呼び出します
2. APIを直接呼 `invalidate.cache` び出す(例 `POST /dispatcher/invalidate.cache`:)

この方法 `invalidate.cache` は、特定のディスパッチャーノードのみを扱うので、サポートされなくなります。
クラウドサービスとしてのAEMは、個々のノードレベルではなくサービスレベルで動作するので、AEMからのキャッシュページの無効化ページの無効化手順は、AEMに対してクラウドサービスとしての [](https://docs.adobe.com/content/help/en/experience-manager-dispatcher/using/configuring/page-invalidate.html) AEMに対しては無効になります。
代わりに、レプリケーションフラッシュエージェントを使用する必要があります。 これは、レプリケーションAPIを使用して行うことができます。 Replication APIのドキュメントは [](https://helpx.adobe.com/experience-manager/6-5/sites/developing/using/reference-materials/javadoc/com/day/cq/replication/Replicator.html) 、ここで入手できます。キャッシュのフラッシュの例については、 [](https://helpx.adobe.com/experience-manager/using/aem64_replication_api.html)`CustomStep` APIの例のページを参照してください。特に、使用可能なすべてのエージェントに対してACTIVATEタイプのレプリケーション・アクションを発行する例を参照してください。 フラッシュエージェントエンドポイントは設定できませんが、フラッシュエージェントを実行する発行サービスと一致する、ディスパッチャーを指すように事前設定されています。 フラッシュエージェントは、通常、OSGiイベントまたはワークフローによってトリガーされます。

次の図に、これを示します。

![CDNCDN](assets/cdnc.png "")

ディスパッチャーキャッシュがクリアされないという問題が発生した場合は、必要に応じてディスパッチャーキャッシュをフラッシュできるカスタマーサポートにお問い合わせください。

アドビが管理するCDNはTTLに従うので、フラッシュする必要はありません。 問題の疑いがある場合は、必要に応じてアドビが管理するCDNキャッシュをフラッシュできるカスタマーサポートにお問い合わせください。

## クライアント側ライブラリとバージョンの整合性 {#content-consistency}

ページはもちろん、HTML、JavaScript、CSS、画像で構成されています。 JSライブラリ間の依存関係を考慮し、JavaScriptおよびCSSリソースをHTMLページに読み込むために、クライアント側ライブラリ(clientlibs)フレームワークを利用することをお勧めします。

clientlibsフレームワークは、自動バージョン管理を提供します。つまり、開発者はソース管理でJSライブラリに対する変更をチェックインでき、最新バージョンは、お客様がリリースをプッシュしたときに利用可能になります。 これがないと、開発者は新しいバージョンのライブラリを参照してHTMLを手動で変更する必要があります。同じライブラリを共有するHTMLテンプレートが多い場合は特に有難です。

新しいバージョンのライブラリが実稼動環境にリリースされると、参照するHTMLページは、更新されたライブラリバージョンへの新しいリンクで更新されます。 特定のHTMLページのブラウザーキャッシュの有効期限が切れた後は、（AEMから）更新されたページで新しいバージョンのライブラリが参照されるので、古いライブラリがブラウザーのキャッシュから読み込まれる心配はありません。 つまり、更新されたHTMLページには、最新のライブラリバージョンがすべて含まれます。

このメカニズムはシリアル化されたハッシュで、クライアントライブラリリンクに追加され、ブラウザーがCSS/JSをキャッシュするための一意のバージョン付きURLを確保します。 シリアル化されたハッシュは、クライアントライブラリの内容が変更された場合にのみ更新されます。 つまり、新しいデプロイメントでも、関連しない更新（クライアントライブラリの基になるcss/jsの変更なし）が発生した場合、参照は同じままになり、ブラウザーのキャッシュの中断が少なくなります。

### クライアント側ライブラリのLongcacheバージョンの有効化 — AEMをクラウドサービスSDKクイックスタートとして有効化 {#enabling-longcache}

HTMLページのデフォルトのclientlibインクルードは、次の例のようになります。

```
<link rel="stylesheet" href="/etc.clientlibs/wkndapp/clientlibs/clientlib-base.css" type="text/css">
```

厳密なclientlibのバージョン管理が有効な場合、クライアントライブラリに長期ハッシュキーがセレクターとして追加されます。 その結果、clientlibの参照は次のようになります。

```
<link rel="stylesheet" href="/etc.clientlibs/wkndapp/clientlibs/clientlib-base.lc-7c8c5d228445ff48ab49a8e3c865c562-lc.css" type="text/css">
```

厳密なclientlibのバージョン管理は、すべてのAEMでクラウドサービス環境としてデフォルトで有効になっています。

ローカルSDKクイックスタートで厳密なclientlibのバージョン管理を有効にするには、次の操作を実行します。

1. OSGi Configuration Managerに移動します。 <host>/system/console/configMgr
1. Adobe Granite HTML Library ManagerのOSGi Configを探します。
   * 「厳密なバージョン管理」を有効にする場合は、チェックボックスをオンにします
   * 「Long term client side cache key」というラベルの付いたフィールドに、/の値を入力します。*；ハッシュ
1. 変更内容を保存します。クラウドサービスとしてのAEMは、開発、ステージ、実稼働環境でこの設定を自動的に有効にするので、この設定をソース管理に保存する必要はありません。
1. クライアントライブラリのコンテンツが変更されるたびに、新しいハッシュキーが生成され、HTML参照が更新されます。
